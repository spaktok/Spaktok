# تصميم المعمارية الأساسية لمشروع Spaktok

## 1. المقدمة

يهدف هذا المستند إلى تحديد التصميم المعماري الأساسي لمنصة Spaktok الجديدة، مع التركيز على البث المباشر، والاتصال في الوقت الفعلي، وإدارة المحتوى، واقتصاد الهدايا، وميزات الكاميرا المتقدمة. سيتم تصميم المعمارية لتكون قابلة للتوسع، ومرنة، وموثوقة، مع الأخذ في الاعتبار المتطلبات العالمية والامتثال.

## 2. المكونات المعمارية الرئيسية

ستتكون منصة Spaktok من المكونات المعمارية الرئيسية التالية:

### 2.1. الواجهة الأمامية (Frontend - Flutter)

*   **التقنية:** Flutter (Android, iOS, Web).
*   **المسؤوليات:**
    *   واجهة المستخدم (UI) وتجربة المستخدم (UX).
    *   عرض البث المباشر والتفاعل معه.
    *   نظام الدردشة في الوقت الفعلي.
    *   التقاط الفيديو والصوت ومعالجة الكاميرا (الفلاتر، التأثيرات).
    *   عرض المحتوى القصير (Reels, Stories).
    *   إدارة ملفات تعريف المستخدمين.
    *   معالجة المدفوعات (عبر بوابات الدفع).
    *   دعم اللغات المتعددة.
*   **التكاملات:**
    *   Firebase Authentication للمصادقة.
    *   Firebase Firestore للدردشة والبيانات في الوقت الفعلي.
    *   Firebase Storage لتخزين الوسائط (الصور، مقاطع الفيديو).
    *   WebRTC أو بروتوكول بث آخر للبث المباشر.
    *   SDKs لبوابات الدفع.
    *   مكتبات معالجة الصور والفيديو.

### 2.2. الواجهة الخلفية (Backend - Node.js/Express & Firebase Cloud Functions)

*   **التقنيات:** Node.js/Express (لخدمات API المخصصة) و Firebase Cloud Functions (للمنطق الخلفي القائم على الأحداث).
*   **المسؤوليات:**
    *   **خدمات البث المباشر:** إدارة جلسات البث، وتتبع حالة البث، وتوزيع الفيديو/الصوت.
    *   **اقتصاد الهدايا:** معالجة شراء العملات الافتراضية، وإرسال الهدايا، وحساب توزيع الأرباح (40% للمذيع، 60% للمنصة).
    *   **إدارة المحتوى:** معالجة تحميل المحتوى (Reels, Stories)، والإبلاغات، والحظر، والحذف.
    *   **المصادقة والترخيص:** إدارة المستخدمين، الأدوار، والأذونات (بالتكامل مع Firebase Authentication).
    *   **الإشعارات:** إرسال إشعارات في الوقت الفعلي (مثل رسائل الدردشة الجديدة، الهدايا، المتابعين الجدد).
    *   **خدمات API:** توفير نقاط نهاية API للواجهة الأمامية للوصول إلى البيانات والوظائف التي لا تغطيها Firebase مباشرة.
    *   **التحقق من حقوق النشر والخصوصية:** تنفيذ منطق للتحقق من المحتوى والامتثال للسياسات.
*   **التكاملات:**
    *   Firebase Firestore, Storage, Authentication.
    *   بوابات الدفع (Stripe, PayPal, إلخ).
    *   خدمات بث الفيديو (مثل Agora.io, Amazon IVS, Wowza).
    *   قواعد البيانات (MongoDB, PostgreSQL, Redis) للبيانات المعقدة أو التحليلات.

### 2.3. قواعد البيانات (Databases)

*   **Firebase Firestore:**
    *   **الاستخدام:** تخزين بيانات الدردشة في الوقت الفعلي، بيانات المستخدمين الأساسية، بيانات الهدايا، بيانات المحتوى القصير (Reels, Stories) للوصول السريع.
    *   **الميزات:** مزامنة البيانات في الوقت الفعلي، قابلية التوسع.
*   **Firebase Storage:**
    *   **الاستخدام:** تخزين جميع الوسائط (مقاطع الفيديو للبث المباشر، Reels, Stories, صور الملف الشخصي، صور الهدايا، صور الفلاتر).
    *   **الميزات:** تخزين كائنات قابل للتوسع، تكامل مع Firebase Cloud Functions لمعالجة الوسائط.
*   **PostgreSQL (أو قاعدة بيانات علائقية أخرى):**
    *   **الاستخدام:** تخزين البيانات العلائقية المعقدة مثل سجلات المعاملات المالية (الهدايا، الأرباح)، بيانات المستخدمين التفصيلية، سجلات الإبلاغات والحظر، بيانات التحليلات.
    *   **الميزات:** سلامة البيانات، استعلامات معقدة.
*   **Redis:**
    *   **الاستخدام:** التخزين المؤقت (Caching) للبيانات المستخدمة بكثرة، إدارة جلسات البث المباشر، قوائم انتظار الرسائل، تتبع المستخدمين المتصلين.
    *   **الميزات:** سرعة عالية، دعم هياكل البيانات المعقدة.

### 2.4. خدمات البث المباشر (Live Streaming Services)

*   **التقنية:** WebRTC أو خدمات بث مخصصة (مثل Agora.io, Amazon IVS).
*   **المسؤوليات:**
    *   التقاط الفيديو والصوت من المذيع.
    *   ترميز (Encoding) وتشفير (Transcoding) الفيديو.
    *   توزيع البث للمشاهدين بأقل زمن انتقال (low latency).
    *   إدارة الجلسات (بدء/إيقاف البث، عدد المشاهدين).

### 2.5. بوابات الدفع (Payment Gateways)

*   **التقنيات:** Stripe, PayPal, أو بوابات دفع محلية أخرى.
*   **المسؤوليات:**
    *   معالجة شراء العملات الافتراضية.
    *   تحويل العملات (من العملة المحلية إلى الدولار الأمريكي).
    *   معالجة سحب الأرباح للمذيعين.

## 3. تدفقات العمل الرئيسية (Key Workflows)

### 3.1. بدء البث المباشر

1.  المذيع يبدأ البث من الواجهة الأمامية (Flutter).
2.  الواجهة الأمامية تتصل بخدمة البث المباشر (مثل WebRTC/Agora).
3.  خدمة البث المباشر تبدأ في استقبال وتوزيع الفيديو/الصوت.
4.  الواجهة الخلفية (Cloud Functions/Node.js) تسجل بدء البث في Firestore/PostgreSQL.

### 3.2. إرسال هدية

1.  المشاهد يشتري عملات افتراضية عبر بوابة الدفع.
2.  المشاهد يرسل هدية للمذيع من الواجهة الأمامية.
3.  الواجهة الأمامية ترسل طلبًا إلى الواجهة الخلفية (Cloud Functions/Node.js).
4.  الواجهة الخلفية تتحقق من رصيد المشاهد، تخصم العملات، وتسجل الهدية في Firestore/PostgreSQL.
5.  الواجهة الخلفية تحسب الأرباح (40% للمذيع، 60% للمنصة) وتحدث أرصدة المستخدمين.
6.  إشعار في الوقت الفعلي للمذيع والمشاهدين بوجود هدية جديدة.

### 3.3. الدردشة في الوقت الفعلي

1.  المستخدم يرسل رسالة من الواجهة الأمامية.
2.  الرسالة تُرسل إلى Firebase Firestore.
3.  Firestore يقوم بمزامنة الرسالة في الوقت الفعلي مع جميع المشاهدين في البث.
4.  منطق خاص في الواجهة الأمامية لإخفاء الرسائل القديمة من نفس المرسل.

## 4. اعتبارات الأمان والخصوصية

*   **المصادقة والترخيص:** استخدام Firebase Authentication مع قواعد أمان Firestore و Storage لضمان الوصول المصرح به فقط.
*   **تشفير البيانات:** تشفير البيانات أثناء النقل (TLS/SSL) وأثناء التخزين (encryption at rest).
*   **الامتثال:** الالتزام بلوائح حماية البيانات (مثل GDPR, CCPA) وحقوق النشر.
*   **المراجعة والاعتدال:** نظام قوي للإبلاغ عن المحتوى والمستخدمين المخالفين، مع أدوات اعتدال (moderation tools) للواجهة الخلفية.

## 5. قابلية التوسع والأداء

*   **Firebase:** يوفر قابلية توسع عالية للبيانات في الوقت الفعلي وتخزين الوسائط.
*   **خدمات البث:** اختيار خدمة بث قابلة للتوسع للتعامل مع عدد كبير من البثوث والمشاهدين.
*   **الواجهة الخلفية:** تصميم الواجهة الخلفية (Node.js/Express) لتكون بلا حالة (stateless) وقابلة للتوسع أفقيًا.
*   **التخزين المؤقت (Caching):** استخدام Redis للتخزين المؤقت لتقليل الحمل على قواعد البيانات الرئيسية وتحسين الأداء.

## 6. التحديات والحلول المقترحة

*   **تحديات Docker في Sandbox:** نظرًا للمشاكل المستمرة، سيتم التركيز على تطوير الميزات بشكل منفصل في الوقت الحالي. يمكن إعادة النظر في استخدام Docker في بيئة تطوير أكثر استقرارًا أو بيئة CI/CD.
*   **تثبيت Flutter SDK:** سيتم افتراض بيئة Flutter مستقرة لتطوير الواجهة الأمامية. في حالة وجود مشاكل في بيئة Sandbox، سيتم التركيز على تصميم الكود وتوثيقه.

## 7. الخطوات التالية

سيتم الانتقال إلى المرحلة التالية: **تخطيط مخطط قاعدة البيانات للمستخدمين، البثوث، الهدايا، الرسائل، والمحتوى**، بناءً على هذا التصميم المعماري.
