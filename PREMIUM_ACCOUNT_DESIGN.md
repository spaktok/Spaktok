# تصميم نظام الحسابات المتميزة في Spaktok

## 1. الهدف

يهدف هذا التصميم إلى إضافة نظام حسابات متميزة يسمح بتعيين 20 حسابًا للحصول على 90% من قيمة العملات التي يتم الحصول عليها من الهدايا. يجب أن يكون النظام مرنًا بحيث يمكن تغيير الحسابات المتميزة ديناميكيًا.

## 2. المكونات الرئيسية

سيتطلب تنفيذ هذا النظام تعديلات في المكونات التالية:

*   **Firestore Data Model:** لتخزين معلومات الحسابات المتميزة وإعدادات النسبة المئوية.
*   **Firebase Cloud Functions:** لمعالجة منطق توزيع العملات وتحديد الحسابات المتميزة.
*   **Flutter Frontend:** لعرض حالة الحساب المتميز وإدارة تعيين الحسابات (للمسؤولين).

## 3. تصميم نموذج البيانات (Firestore Data Model)

### 3.1. مجموعة `users` (المستخدمون)

سيتم إضافة حقل جديد إلى كل مستند مستخدم في مجموعة `users`:

*   `isPremiumAccount`: (Boolean) يشير إلى ما إذا كان الحساب متميزًا أم لا. القيمة الافتراضية `false`.
*   `premiumSlotId`: (String, Optional) معرف فريد للخانة المتميزة التي يشغلها الحساب (مثل "premium_slot_1"). هذا سيساعد في تتبع وإدارة الـ 20 خانة المتاحة.

### 3.2. مجموعة `settings` (الإعدادات)

سيتم إنشاء مستند واحد في مجموعة `settings` (أو تحديث مستند موجود) لتخزين الإعدادات العامة للنظام:

*   `premiumPayoutPercentage`: (Number) النسبة المئوية التي يحصل عليها الحساب المتميز (مثال: 0.90 لـ 90%).
*   `standardPayoutPercentage`: (Number) النسبة المئوية التي يحصل عليها الحساب العادي (مثال: 0.50 لـ 50%).
*   `maxPremiumSlots`: (Number) الحد الأقصى لعدد الحسابات المتميزة المسموح بها (مثال: 20).
*   `premiumSlots`: (Map) خريطة لتتبع الخانات المتميزة المتاحة والمشغولة. المفتاح هو `premiumSlotId` والقيمة هي `userId` الذي يشغل الخانة.
    ```json
    {
      "premium_slot_1": "user_id_A",
      "premium_slot_2": "user_id_B",
      // ... حتى 20 خانة
      "premium_slot_20": "user_id_Z"
    }
    ```

## 4. تصميم Firebase Cloud Functions

### 4.1. وظيفة `processGiftPayout` (معالجة دفع الهدايا)

ستكون هذه الوظيفة مسؤولة عن حساب وتوزيع العملات بعد تلقي هدية. سيتم تعديلها لتأخذ في الاعتبار حالة `isPremiumAccount` للمستلم.

**المنطق:**

1.  عند تلقي هدية، يتم استدعاء هذه الوظيفة.
2.  جلب معلومات المستلم من مجموعة `users`.
3.  جلب إعدادات الدفع من مستند `settings`.
4.  إذا كان `user.isPremiumAccount` صحيحًا، استخدم `premiumPayoutPercentage`.
5.  وإلا، استخدم `standardPayoutPercentage`.
6.  احسب المبلغ المستحق وقم بتحديث رصيد العملات للمستلم.

### 4.2. وظيفة `managePremiumAccount` (إدارة الحساب المتميز)

ستكون هذه الوظيفة قابلة للاستدعاء (Callable Cloud Function) للسماح للمسؤولين بتعيين أو إلغاء تعيين الحسابات كحسابات متميزة.

**المدخلات:**

*   `userId`: (String) معرف المستخدم المراد تعديله.
*   `action`: (String) `"assign"` أو `"unassign"`.
*   `slotId`: (String, Optional) معرف الخانة المتميزة المراد تعيينها (مطلوب لـ `"assign"`).

**المنطق (لـ `"assign"`):**

1.  **التحقق من الصلاحيات:** التأكد من أن المستخدم الذي يستدعي الوظيفة هو مسؤول.
2.  **التحقق من الخانة:** التأكد من أن `slotId` صالح ومتاح (غير مشغول أو مشغول بنفس `userId`).
3.  **التحقق من العدد:** التأكد من أن عدد الخانات المتميزة المشغولة لا يتجاوز `maxPremiumSlots`.
4.  **تحديث المستخدم:** تعيين `user.isPremiumAccount = true` و `user.premiumSlotId = slotId`.
5.  **تحديث الإعدادات:** تحديث `settings.premiumSlots` لتعيين `slotId` إلى `userId`.

**المنطق (لـ `"unassign"`):**

1.  **التحقق من الصلاحيات:** التأكد من أن المستخدم الذي يستدعي الوظيفة هو مسؤول.
2.  **تحديث المستخدم:** تعيين `user.isPremiumAccount = false` و `user.premiumSlotId = null`.
3.  **تحديث الإعدادات:** إزالة `userId` من `settings.premiumSlots` للخانة المعنية.

## 5. تصميم الواجهة الأمامية (Flutter Frontend)

### 5.1. شاشة إدارة المسؤولين (Admin Management Screen)

*   ستوفر هذه الشاشة واجهة للمسؤولين لعرض قائمة المستخدمين.
*   بجانب كل مستخدم، سيكون هناك زر أو تبديل لتعيين/إلغاء تعيين الحساب كحساب متميز.
*   عند التعيين، يمكن للمسؤول اختيار `slotId` من قائمة الخانات المتاحة.
*   ستعرض الشاشة أيضًا عدد الخانات المتميزة المتاحة والمشغولة.
*   ستقوم الواجهة الأمامية باستدعاء وظيفة `managePremiumAccount` عند إجراء التغييرات.

## 6. قواعد أمان Firestore (Firestore Security Rules)

يجب تحديث قواعد أمان Firestore لضمان ما يلي:

*   يمكن للمستخدمين قراءة حقل `isPremiumAccount` الخاص بهم.
*   يمكن للمسؤولين فقط تعديل حقل `isPremiumAccount` و `premiumSlotId` في مجموعة `users`.
*   يمكن للمسؤولين فقط قراءة وتعديل مستند `settings`.

## 7. الخطوات التالية

1.  تعديل `firebase.json` و `firestore.rules` و `functions/index.js`.
2.  تعديل كود Flutter في `lib/` لتطبيق التغييرات في الواجهة الأمامية.
3.  اختبار شامل لجميع الميزات الجديدة.
